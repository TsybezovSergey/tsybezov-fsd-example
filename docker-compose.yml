version: "3.9"

services:
  # Docker-in-Docker –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤
  dind:
    image: docker:27-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    networks:
      - dindnet
    platform: linux/arm64
    command: dockerd --host=tcp://0.0.0.0:2375 --host=unix:///var/run/docker.sock

  # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  builder:
    image: docker:27-cli
    depends_on:
      - dind
      - postgres
    environment:
      - DOCKER_HOST=tcp://dind:2375
      - DOCKER_TLS_CERTDIR=
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=dev
      - POSTGRES_PASSWORD=dev
      - POSTGRES_DB=dev
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - dindnet
    platform: linux/arm64
    command: >
      sh -c "
        echo 'üì¶ Installing PostgreSQL client...';
        apk update && apk add --no-cache postgresql-client > /dev/null;
        echo '‚è≥ Waiting for PostgreSQL...';
        until pg_isready -h postgres -p 5432 -U dev; do sleep 2; done;
        echo '‚úÖ PostgreSQL is up!';
        docker version &&
        docker build -t myimage . &&
        echo 'üèÅ Build complete.';
      "

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=dev
      - POSTGRES_PASSWORD=dev
      - POSTGRES_DB=dev
    ports:
      - "5432:5432"
    networks:
      - dindnet
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    platform: linux/arm64

volumes:
  dind-certs:
  pgdata:

networks:
  dindnet:
